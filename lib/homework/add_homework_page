import 'dart:convert';
import 'dart:io';
import 'package:file_picker/file_picker.dart';
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'package:intl/intl.dart';
import 'package:shared_preferences/shared_preferences.dart';

class AddHomeworkPage extends StatefulWidget {
  const AddHomeworkPage({super.key});

  @override
  State<AddHomeworkPage> createState() => _AddHomeworkPageState();
}

class _AddHomeworkPageState extends State<AddHomeworkPage> {
  final titleController = TextEditingController();
  final descriptionController = TextEditingController();
  final assignDateController = TextEditingController();
  final submissionDateController = TextEditingController();

  String? selectedClass;
  String? selectedSection;
  File? attachment;

  final List<String> classes = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
  final List<String> sections = ['A', 'B', 'C', 'D'];

  Future<void> _pickDate(BuildContext context, TextEditingController controller) async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: DateTime.now(),
      firstDate: DateTime(2020),
      lastDate: DateTime(2030),
    );
    if (picked != null) {
      controller.text = DateFormat('yyyy-MM-dd').format(picked);
    }
  }

  Future<void> _pickFile() async {
    final result = await FilePicker.platform.pickFiles();
    if (result != null) {
      setState(() => attachment = File(result.files.single.path!));
    }
  }

  Future<void> _submitHomework() async {
    if (selectedClass == null ||
        selectedSection == null ||
        assignDateController.text.isEmpty ||
        submissionDateController.text.isEmpty ||
        titleController.text.isEmpty ||
        descriptionController.text.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Please fill all fields.")),
      );
      return;
    }

    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('token') ?? '';

    var request = http.MultipartRequest(
      'POST',
      Uri.parse('https://rmps.apppro.in/api/teacher/homework'),
    );

    request.headers.addAll({
      'Authorization': 'Bearer $token',
      'Accept': 'application/json',
    });

    request.fields['class'] = selectedClass!;
    request.fields['section'] = selectedSection!;
    request.fields['homework_title'] = titleController.text.trim();
    request.fields['remark'] = descriptionController.text.trim();
    request.fields['work_date'] = assignDateController.text.trim();
    request.fields['submission_date'] = submissionDateController.text.trim();

    if (attachment != null) {
      request.files.add(await http.MultipartFile.fromPath('attachment', attachment!.path));
    }

    final response = await request.send();

    if (response.statusCode == 200) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("✅ Homework submitted successfully!")),
      );
      Navigator.pop(context, true); // <- inform previous screen to refresh
    } else {
      final body = await response.stream.bytesToString();
      print("Homework submission failed: $body");
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("❌ Submission failed. Please try again.")),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Add Homework'),
        backgroundColor: Colors.deepPurple,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: SingleChildScrollView(
          child: Column(
            children: [
              DropdownButtonFormField<String>(
                value: selectedClass,
                decoration: const InputDecoration(
                  labelText: 'Class',
                  border: OutlineInputBorder(),
                ),
                items: classes.map((c) => DropdownMenuItem(value: c, child: Text(c))).toList(),
                onChanged: (val) => setState(() => selectedClass = val),
              ),
              const SizedBox(height: 12),
              DropdownButtonFormField<String>(
                value: selectedSection,
                decoration: const InputDecoration(
                  labelText: 'Section',
                  border: OutlineInputBorder(),
                ),
                items: sections.map((s) => DropdownMenuItem(value: s, child: Text(s))).toList(),
                onChanged: (val) => setState(() => selectedSection = val),
              ),
              const SizedBox(height: 12),
              TextFormField(
                controller: assignDateController,
                readOnly: true,
                decoration: const InputDecoration(
                  labelText: 'Assign Date',
                  border: OutlineInputBorder(),
                  suffixIcon: Icon(Icons.calendar_today),
                ),
                onTap: () => _pickDate(context, assignDateController),
              ),
              const SizedBox(height: 12),
              TextFormField(
                controller: submissionDateController,
                readOnly: true,
                decoration: const InputDecoration(
                  labelText: 'Submission Date',
                  border: OutlineInputBorder(),
                  suffixIcon: Icon(Icons.calendar_today),
                ),
                onTap: () => _pickDate(context, submissionDateController),
              ),
              const SizedBox(height: 12),
              TextFormField(
                controller: titleController,
                decoration: const InputDecoration(
                  labelText: 'Homework Title',
                  border: OutlineInputBorder(),
                ),
              ),
              const SizedBox(height: 12),
              TextFormField(
                controller: descriptionController,
                decoration: const InputDecoration(
                  labelText: 'Description',
                  border: OutlineInputBorder(),
                ),
                maxLines: 4,
              ),
              const SizedBox(height: 10),
              ElevatedButton.icon(
                onPressed: _pickFile,
                icon: const Icon(Icons.attach_file),
                label: Text(attachment != null ? 'File Selected' : 'Attach File'),
              ),
              const SizedBox(height: 20),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: _submitHomework,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.deepPurple,
                    padding: const EdgeInsets.symmetric(vertical: 14),
                  ),
                  child: const Text("Submit", style: TextStyle(fontSize: 16, color: Colors.white)),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
